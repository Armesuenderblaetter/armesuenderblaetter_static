// MIT License

// Copyright (c) 2024 Austrian Centre for Digital Humanities & Cultural Heritage

// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:

// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
// https://github.com/acdh-oeaw/acdh-noske-search
// version of code 1.1 
var W=Object.defineProperty;var Q=(r,e,t)=>e in r?W(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var p=(r,e,t)=>(Q(r,typeof e!="symbol"?e+"":e,t),t);var R=class{constructor(){p(this,"_fns");this._fns=[]}eject(e){let t=this._fns.indexOf(e);t!==-1&&(this._fns=[...this._fns.slice(0,t),...this._fns.slice(t+1)])}use(e){this._fns=[...this._fns,e]}},d={BASE:"",CREDENTIALS:"include",ENCODE_PATH:void 0,HEADERS:void 0,PASSWORD:void 0,TOKEN:void 0,USERNAME:void 0,VERSION:"2.0.0",WITH_CREDENTIALS:!1,interceptors:{request:new R,response:new R}};var T=class extends Error{constructor(t,o,s){super(s);p(this,"url");p(this,"status");p(this,"statusText");p(this,"body");p(this,"request");this.name="ApiError",this.url=o.url,this.status=o.status,this.statusText=o.statusText,this.body=o.body,this.request=t}};var I=class extends Error{constructor(e){super(e),this.name="CancelError"}get isCancelled(){return!0}},v=class{constructor(e){p(this,"_isResolved");p(this,"_isRejected");p(this,"_isCancelled");p(this,"cancelHandlers");p(this,"promise");p(this,"_resolve");p(this,"_reject");this._isResolved=!1,this._isRejected=!1,this._isCancelled=!1,this.cancelHandlers=[],this.promise=new Promise((t,o)=>{this._resolve=t,this._reject=o;let s=a=>{this._isResolved||this._isRejected||this._isCancelled||(this._isResolved=!0,this._resolve&&this._resolve(a))},i=a=>{this._isResolved||this._isRejected||this._isCancelled||(this._isRejected=!0,this._reject&&this._reject(a))},n=a=>{this._isResolved||this._isRejected||this._isCancelled||this.cancelHandlers.push(a)};return Object.defineProperty(n,"isResolved",{get:()=>this._isResolved}),Object.defineProperty(n,"isRejected",{get:()=>this._isRejected}),Object.defineProperty(n,"isCancelled",{get:()=>this._isCancelled}),e(s,i,n)})}get[Symbol.toStringTag](){return"Cancellable Promise"}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}cancel(){if(!(this._isResolved||this._isRejected||this._isCancelled)){if(this._isCancelled=!0,this.cancelHandlers.length)try{for(let e of this.cancelHandlers)e()}catch(e){console.warn("Cancellation threw an error",e);return}this.cancelHandlers.length=0,this._reject&&this._reject(new I("Request aborted"))}}get isCancelled(){return this._isCancelled}};var D=r=>typeof r=="string",S=r=>D(r)&&r!=="",A=r=>r instanceof Blob,k=r=>r instanceof FormData,Y=r=>r>=200&&r<300,J=r=>{try{return btoa(r)}catch{return Buffer.from(r).toString("base64")}},V=r=>{let e=[],t=(s,i)=>{e.push(`${encodeURIComponent(s)}=${encodeURIComponent(String(i))}`)},o=(s,i)=>{i!=null&&(i instanceof Date?t(s,i.toISOString()):Array.isArray(i)?i.forEach(n=>o(s,n)):typeof i=="object"?Object.entries(i).forEach(([n,a])=>o(`${s}[${n}]`,a)):t(s,i))};return Object.entries(r).forEach(([s,i])=>o(s,i)),e.length?`?${e.join("&")}`:""},X=(r,e)=>{let t=r.ENCODE_PATH||encodeURI,o=e.url.replace("{api-version}",r.VERSION).replace(/{(.*?)}/g,(i,n)=>e.path?.hasOwnProperty(n)?t(String(e.path[n])):i),s=r.BASE+o;return e.query?s+V(e.query):s},K=r=>{if(r.formData){let e=new FormData,t=(o,s)=>{D(s)||A(s)?e.append(o,s):e.append(o,JSON.stringify(s))};return Object.entries(r.formData).filter(([,o])=>o!=null).forEach(([o,s])=>{Array.isArray(s)?s.forEach(i=>t(o,i)):t(o,s)}),e}},E=async(r,e)=>typeof e=="function"?e(r):e,Z=async(r,e)=>{let[t,o,s,i]=await Promise.all([E(e,r.TOKEN),E(e,r.USERNAME),E(e,r.PASSWORD),E(e,r.HEADERS)]),n=Object.entries({Accept:"application/json",...i,...e.headers}).filter(([,a])=>a!=null).reduce((a,[c,l])=>({...a,[c]:String(l)}),{});if(S(t)&&(n.Authorization=`Bearer ${t}`),S(o)&&S(s)){let a=J(`${o}:${s}`);n.Authorization=`Basic ${a}`}return e.body!==void 0&&(e.mediaType?n["Content-Type"]=e.mediaType:A(e.body)?n["Content-Type"]=e.body.type||"application/octet-stream":D(e.body)?n["Content-Type"]="text/plain":k(e.body)||(n["Content-Type"]="application/json")),new Headers(n)},ee=r=>{if(r.body!==void 0)return r.mediaType?.includes("application/json")||r.mediaType?.includes("+json")?JSON.stringify(r.body):D(r.body)||A(r.body)||k(r.body)?r.body:JSON.stringify(r.body)},te=async(r,e,t,o,s,i,n)=>{let a=new XMLHttpRequest;return a.open(e.method,t,!0),a.withCredentials=r.WITH_CREDENTIALS,i.forEach((c,l)=>{a.setRequestHeader(l,c)}),new Promise(async(c,l)=>{a.onload=()=>c(a),a.onabort=()=>l(new Error("Request aborted")),a.onerror=()=>l(new Error("Network error"));for(let h of r.interceptors.request._fns)a=await h(a);a.send(o??s),n(()=>a.abort())})},re=(r,e)=>{if(e){let t=r.getResponseHeader(e);if(D(t))return t}},se=r=>{if(r.status!==204)try{let e=r.getResponseHeader("Content-Type");if(e)return e.includes("application/json")||e.includes("+json")?JSON.parse(r.responseText):r.responseText}catch(e){console.error(e)}},oe=(r,e)=>{let o={400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"Im a teapot",421:"Misdirected Request",422:"Unprocessable Content",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required",...r.errors}[e.status];if(o)throw new T(r,e,o);if(!e.ok){let s=e.status??"unknown",i=e.statusText??"unknown",n=(()=>{try{return JSON.stringify(e.body,null,2)}catch{return}})();throw new T(r,e,`Generic Error: status: ${s}; status text: ${i}; body: ${n}`)}},y=(r,e)=>new v(async(t,o,s)=>{try{let i=X(r,e),n=K(e),a=ee(e),c=await Z(r,e);if(!s.isCancelled){let l=await te(r,e,i,a,n,c,s);for(let m of r.interceptors.response._fns)l=await m(l);let h=se(l),w=re(l,e.responseHeader),u={url:i,ok:Y(l.status),status:l.status,statusText:l.statusText,body:w??h};oe(e,u),t(u.body)}}catch(i){o(i)}});var q=class{static getCorpInfo(e){return y(d,{method:"GET",url:"/search/corp_info",query:{corpname:e.corpname,usesubcorp:e.usesubcorp,subcorpora:e.subcorpora,gramrels:e.gramrels,corpcheck:e.corpcheck,registry:e.registry,struct_attr_stats:e.structAttrStats,format:e.format}})}static getWordList(e){return y(d,{method:"GET",url:"/search/wordlist",query:{corpname:e.corpname,wlattr:e.wlattr,usesubcorp:e.usesubcorp,wlnums:e.wlnums,wlmaxfreq:e.wlmaxfreq,wlminfreq:e.wlminfreq,wlpat:e.wlpat,wlsort:e.wlsort,wlblacklist:e.wlblacklist,include_nonwords:e.includeNonwords,relfreq:e.relfreq,reldocf:e.reldocf,wlfile:e.wlfile,wlicase:e.wlicase,wlmaxitems:e.wlmaxitems,wlpage:e.wlpage,format:e.format,random:e.random,wltype:e.wltype,ngrams_n:e.ngramsN,ngrams_max_n:e.ngramsMaxN,nest_ngrams:e.nestNgrams,simple_n:e.simpleN,usengrams:e.usengrams}})}static getStructWordList(e){return y(d,{method:"GET",url:"/search/struct_wordlist",query:{corpname:e.corpname,wlattr:e.wlattr,wlstruct_attr1:e.wlstructAttr1,wlstruct_attr2:e.wlstructAttr2,wlstruct_attr3:e.wlstructAttr3,wlnums:e.wlnums,wlmaxfreq:e.wlmaxfreq,wlminfreq:e.wlminfreq,wlmaxitems:e.wlmaxitems,wlpat:e.wlpat,wlsort:e.wlsort,wlblacklist:e.wlblacklist,include_nonwords:e.includeNonwords,relfreq:e.relfreq,reldocf:e.reldocf,wlicase:e.wlicase,wlpage:e.wlpage,format:e.format,random:e.random,wltype:e.wltype}})}static getConcordance(e){return y(d,{method:"GET",url:"/search/concordance",query:{corpname:e.corpname,q:e.q,"concordance_query[queryselector]":e.concordanceQueryQueryselector,"concordance_query[iquery]":e.concordanceQueryIquery,"concordance_query[cql]":e.concordanceQueryCql,"concordance_query[lemma]":e.concordanceQueryLemma,"concordance_query[char]":e.concordanceQueryChar,"concordance_query[word]":e.concordanceQueryWord,"concordance_query[phrase]":e.concordanceQueryPhrase,usesubcorp:e.usesubcorp,lpos:e.lpos,default_attr:e.defaultAttr,attrs:e.attrs,refs:e.refs,attr_allpos:e.attrAllpos,viewmode:e.viewmode,cup_hl:e.cupHl,structs:e.structs,fromp:e.fromp,pagesize:e.pagesize,kwicleftctx:e.kwicleftctx,kwicrightctx:e.kwicrightctx,errcorr_switch:e.errcorrSwitch,cup_err_code:e.cupErrCode,cup_err:e.cupErr,cup_corr:e.cupCorr,json:e.json,asyn:e.asyn,format:e.format}})}static getFullRef(e){return y(d,{method:"GET",url:"/search/fullref",query:{corpname:e.corpname,pos:e.pos}})}static getWideCtx(e){return y(d,{method:"GET",url:"/search/widectx",query:{corpname:e.corpname,pos:e.pos,hitlen:e.hitlen,structs:e.structs,detail_left_ctx:e.detailLeftCtx,detail_right_ctx:e.detailRightCtx}})}static getFreqMl(e){return y(d,{method:"GET",url:"/search/freqml",query:{corpname:e.corpname,ml1attr:e.ml1Attr,ml1ctx:e.ml1Ctx,ml2attr:e.ml2Attr,ml2ctx:e.ml2Ctx,ml3attr:e.ml3Attr,ml3ctx:e.ml3Ctx,ml4attr:e.ml4Attr,ml4ctx:e.ml4Ctx,ml5attr:e.ml5Attr,ml5ctx:e.ml5Ctx,ml6attr:e.ml6Attr,ml6ctx:e.ml6Ctx,q:e.q,usesubcorp:e.usesubcorp,fmaxitems:e.fmaxitems,fpage:e.fpage,group:e.group,showpoc:e.showpoc,showreltt:e.showreltt,showrel:e.showrel,freqlevel:e.freqlevel,json:e.json,freq_sort:e.freqSort,format:e.format}})}static getFregDistrib(e){return y(d,{method:"GET",url:"/search/freq_distrib",query:{corpname:e.corpname,res:e.res,lpos:e.lpos,default_attr:e.defaultAttr,attrs:e.attrs,structs:e.structs,refs:e.refs,attr_allpos:e.attrAllpos,viewmode:e.viewmode,fc_lemword_window_type:e.fcLemwordWindowType,fc_lemword_wsize:e.fcLemwordWsize,fc_lemword_type:e.fcLemwordType,fc_pos_window_type:e.fcPosWindowType,fc_pos_wsize:e.fcPosWsize,fc_pos_type:e.fcPosType,json:e.json,normalize:e.normalize,format:e.format}})}static getFreqDist(e){return y(d,{method:"GET",url:"/search/freqdist",query:{corpname:e.corpname,wlattr:e.wlattr,diaattr:e.diaattr,sse:e.sse,threshold:e.threshold,ctx:e.ctx,wordlist:e.wordlist,json:e.json}})}static getCollx(e){return y(d,{method:"GET",url:"/search/collx",query:{corpname:e.corpname,q:e.q,usesubcorp:e.usesubcorp,cattr:e.cattr,csortfn:e.csortfn,cbgrfns:e.cbgrfns,cfromw:e.cfromw,ctow:e.ctow,cminfreq:e.cminfreq,cminbgr:e.cminbgr,cmaxitems:e.cmaxitems,json:e.json}})}static getSubCorp(e){return y(d,{method:"GET",url:"/search/subcorp",query:{corpname:e.corpname,subcname:e.subcname,create:e.create,delete:e._delete,q:e.q,struct:e.struct,json:e.json,format:e.format}})}static subcorpusRename(e){return y(d,{method:"GET",url:"/search/subcorpus_rename",query:{corpname:e.corpname,subcorp_id:e.subcorpId,new_subcorp_name:e.newSubcorpName}})}static subcorpusInfo(e){return y(d,{method:"GET",url:"/search/subcorp_info",query:{corpname:e.corpname,subcname:e.subcname}})}static getExtractKeywords(e){return y(d,{method:"GET",url:"/search/extract_keywords",query:{corpname:e.corpname,ref_corpname:e.refCorpname,usesubcorp:e.usesubcorp,simple_n:e.simpleN,wlfile:e.wlfile,wlblacklist:e.wlblacklist,attr:e.attr,alnum:e.alnum,onealpha:e.onealpha,minfreq:e.minfreq,maxfreq:e.maxfreq,max_keywords:e.maxKeywords,include_nonwords:e.includeNonwords,icase:e.icase,wlpat:e.wlpat,addfreqs:e.addfreqs,reldocf:e.reldocf,usengrams:e.usengrams,ngrams_n:e.ngramsN,ngrams_max_n:e.ngramsMaxN,format:e.format}})}static getTextTypesWithNorms(e){return y(d,{method:"GET",url:"/search/textypes_with_norms",query:{corpname:e.corpname}})}static getAttrVals(e){return y(d,{method:"GET",url:"/search/attr_vals",query:{corpname:e.corpname,avattr:e.avattr,avpat:e.avpat,avfrom:e.avfrom,avmaxitems:e.avmaxitems,icase:e.icase,format:e.format}})}};d.interceptors.response.use(r=>(r.status===200&&console.log(`request to ${r.status} was successful`),r));function ie(r){let e=r.split(" "),t="q";for(let o=0;o<e.length;o++)t+='"'+e[o]+'" ';return t}async function j(r){return await q.getWordList({corpname:r.corpname,wlattr:r.wlattr,wlpat:r.wlpat,wlmaxitems:r.wlmaxitems,wltype:r.wltype,includeNonwords:r.includeNonwords,wlicase:r.wlicase,wlminfreq:r.wlminfreq})}async function C(r,e){let t=document.querySelector(`#${e.selectQueryId}`),o=e.urlparam?"url":t.value;var s=o==="simple"?ie(r):o==="url"?r:`q${r}`;let i=await q.getConcordance({corpname:e.corpname,q:s,viewmode:e.viewmode,attrs:e.attrs,format:e.format,structs:e.structs,kwicrightctx:e.kwicrightctx,kwicleftctx:e.kwicleftctx,refs:e.refs,pagesize:e.pagesize,fromp:e.fromp});o==="url"&&(t.value="cql");let n=new URLSearchParams(window.location.search);return n.set("corpname",e.corpname),n.set("q",s),n.set("viewmode",e.viewmode),n.set("attrs",e.attrs),n.set("format",e.format),n.set("structs",e.structs),n.set("kwicrightctx",e.kwicrightctx),n.set("kwicleftctx",e.kwicleftctx),n.set("refs",e.refs),n.set("pagesize",e.pagesize.toString()),n.set("fromp",e.fromp.toString()),n.set("selectQueryValue","url"),window.history.pushState({},"",`${window.location.pathname}?${n}`),i.Lines&&i.Lines.length===0?"No results found":(i.error&&(i.error=`${i.error} see documentation at <a target="_blank" class="text-blue-500" href="https://www.sketchengine.eu/documentation/corpus-querying/">https://www.sketchengine.eu/documentation/corpus-querying/</a>`),i)}function L(r){let e=[];return r.Lines?.map(t=>{let o=t.Left?.map(c=>c.str).join(" "),s=t.Right?.map(c=>c.str).join(" "),i=t.Kwic?.map(c=>c.str).join(" "),n=t.Refs?.map(c=>c),a={left:o,right:s,kwic:i,refs:n};e.push(a)}),e}function N(r,e){let t=[];return r.Items?.map(o=>{let s=o.frq,i=o.relfreq,n=o.str,a={frq:s,relfreq:i,str:n,attr:e};t.push(a)}),t}function U(r,e,t){document.getElementById(t.id)?.remove();let o=document.querySelector(`#${e}`),s=document.createElement("div");s.id=t.id,s.classList.add(...t.css.div.split(" "));let i=document.createElement("ul");i.classList.add(...t.css.ul.split(" ")),r.map(n=>{let a=document.createElement("li");a.classList.add(...t.css.li.split(" ")),a.innerHTML=n.str+" | "+n.frq+" | "+n.attr,a.addEventListener("click",()=>{document.getElementById(e+"-select").value="cql";let c=document.getElementById(e+"-input");c.value="["+n.attr+'="'+n.str+'"]'}),i.appendChild(a)}),s.appendChild(i),o?.prepend(s)}function G(r){return r.fullsize}function P(r,e=!1){if(e){for(let o of r)if(o.startsWith("doc.id"))return[o.split("=")[1]]}else{var t=[];for(let o of r)o===""||o===void 0||o===null||o.startsWith("doc")||t.push(o);return t}return null}var f={div:"overflow-x-auto",table:"table",thead:"text-center",trHead:"",th:"text-sm text-gray-500",tbody:"",trBody:"p-2",td:"text-sm text-gray-500",kwic:"text-lg text-red-500",left:"text-sm text-gray-500 p-2 text-right",right:"text-sm text-gray-500 p-2 text-left"};function O(r,e,t,o=!1,s){let i=document.querySelector(`#${e}`);i.innerHTML=`
		<div class="${s.css?.div||f.div}">
			<table class="${s.css?.table||f.table}">
				<thead class="${s.css?.thead||f.thead}">
				<tr class="${s.css?.trHead||f.trHead}" id="hits-header-row">
				</tr>
				</thead>
				<tbody class="${s.css?.tbody||f.tbody}" id="hits-table-body">
				</tbody>
			</table>
		</div>
		`;let n=document.querySelector("#hits-table-body");var a=`<th class="${s.css?.th||f.th}">Left KWIC</th>
							<th class="${s.css?.th||f.th}">Context</th>
							<th class="${s.css?.th||f.th}">Right KWIC</th>`,c="";let l=r.map(u=>{let m=u.left,x=u.right,g=u.kwic,_=u.refs,$=P(_,!0),z=P(_,!1),H=t.endsWith("/")?t:t+"/";c=_.filter(b=>b.length>0).map(b=>`<th class="${s.css?.th||f.th}">${b.split("=")[0]}</th>`).join("");let M=_.filter(b=>b.length>0).map(b=>`<td class="${s.css?.td||f.td}">${b.split("=")[1]}</td>`).join(""),B=z.filter(b=>!b.startsWith("doc")&&b.length>0).map(b=>`#${b.split("=")[1]}`).join("");return`
			<tr class="${s.css?.trBody||f.trBody}">
				${M}
				<td class="${s.css?.left||f.left}">${m}</td>
				<td class="${s.css?.kwic||f.kwic}">
					<a href="${H}${$}?mark=${g.trim()}&noSearch=true${o}${B}">
						${g}
					</a>
				</td>
				<td class="${s.css?.right||f.right}">${x}</td>
			</tr>
			`}).join(""),h=c+a,w=document.querySelector("#hits-header-row");w.innerHTML=h,n.innerHTML=l}var F=class{constructor(e){p(this,"viewmode","kwic");p(this,"attrs","word,id");p(this,"format","json");p(this,"structs","doc");p(this,"kwicrightctx","100#");p(this,"kwicleftctx","100#");p(this,"refs","doc.id");p(this,"pagesize",20);p(this,"fromp",1);p(this,"container","noske-search");p(this,"inputPlaceholder","Search for words, phrases or CQL queries (Regex allowed)");p(this,"hitsCss","p-2");p(this,"results","No Hits found. Please try another search query.");p(this,"paginationcss","p-2");p(this,"selectcss","basis-2/12 p-2");p(this,"inputcss","basis-10/12 rounded border p-2");p(this,"div1css","flex flex-row p-2");p(this,"button","search");p(this,"buttoncss","p-2");p(this,"selectQueryCss","basis-2/12 p-2");p(this,"customUrl","");p(this,"urlparam",!1);p(this,"statsDiv","flex flex-row m-2");p(this,"statsLabel","p-2");p(this,"statsLabelValue","Hits:");p(this,"wordlistattr",["word","lemma","type","id"]);p(this,"autocompleteOptions",{id:"noske-autocomplete",css:{div:"bg-white border border-gray-300 absolute ml-40 mt-10 text-left",ul:"p-0",li:"p-2 hover:bg-gray-100 text-sm text-gray-500 hover:cursor-pointer"}});p(this,"minQueryLength",2);p(this,"autocomplete",!1);e?.container||console.log("No container defined. Default container id set to 'noske-search'."),this.autocomplete=e?.autocomplete||this.autocomplete,this.container=e?.container||this.container,this.wordlistattr=e?.wordlistattr||this.wordlistattr}search({debug:e=!1,client:t,hits:o,pagination:s,searchInput:i,config:n,stats:a,autocompleteOptions:c}){if(this.searchInput(i),this.clearResults(o.id,s.id,i.id,a.id),!o.id)throw new Error("hits.id is not defined");if(this.searchHits(o),!s.id)throw new Error("pagination.id is not defined");if(this.searchPagination(s),t.base===void 0||t.base==="")throw new Error("Base URL is not defined");if(d.BASE=t.base,t.corpname===void 0||t.corpname==="")throw new Error("Corpus name is not defined");let l=document.querySelector(`#${i?.id}-select`),h=document.querySelector(`input#${i?.id}-input`),w=document.querySelector("button#noske-search-button");h.addEventListener("keyup",async u=>{if(u.key!=="Enter")if(this.autocomplete&&u.target.value.length>=this.minQueryLength){var m=[];for(let x of this.wordlistattr){if(x.length===0)return;let g=await j({corpname:t.corpname,wlattr:x,wlmaxitems:100,wlpat:`.*${u.target.value}.*`,wltype:"simple",includeNonwords:1,wlicase:1,wlminfreq:0});e&&g!==null&&console.log(g);let _=N(g,x);m.push(..._)}setTimeout(()=>{U(m,i.id,c||this.autocompleteOptions)},400)}else return;else{let x=u.target.value;if(x.length>=this.minQueryLength){let g=await C(x,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:t.pagesize||this.pagesize,fromp:t.fromp||this.fromp,selectQueryId:`${i?.id}-select`});e&&g!==null&&console.log(g),await this.transformResponse(g,t,o,s,n,a),await this.createPagination(1,t,o,s,i.id,n,a)}}}),h.addEventListener("focus",async()=>{setTimeout(()=>{document.getElementById(c.id||"noske-autocomplete")?.remove()},200)}),w.addEventListener("click",async()=>{let u=h.value;if(u.length>=this.minQueryLength){let m=await C(u,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:t.pagesize||this.pagesize,fromp:t.fromp||this.fromp,selectQueryId:`${i?.id}-select`});e&&m!==null&&console.log(m),await this.transformResponse(m,t,o,s,n,a),await this.createPagination(1,t,o,s,i.id,n,a)}setTimeout(()=>{document.getElementById(c.id||"noske-autocomplete")?.remove()},200)}),(async()=>{let u=new URL(window.location.href),m=u.searchParams.get("q");if(m){e?l.value="simple":l.value="cql";let x=document.querySelector(`input#${i?.id}-input`);x.value=m?.startsWith("q")?m.slice(1):m;let g=await C(m,{corpname:u.searchParams.get("corpname"),viewmode:u.searchParams.get("viewmode"),attrs:u.searchParams.get("attrs"),format:u.searchParams.get("format"),structs:u.searchParams.get("structs"),kwicrightctx:u.searchParams.get("kwicrightctx"),kwicleftctx:u.searchParams.get("kwicleftctx"),refs:u.searchParams.get("refs"),pagesize:parseInt(u.searchParams.get("pagesize")),fromp:parseInt(u.searchParams.get("fromp")),selectQueryId:`${i?.id}-select`,urlparam:!0});e&&g!==null&&console.log(g),await this.transformResponse(g,t,o,s,n,a),await this.createPagination(1,t,o,s,i.id,n,a)}})()}searchHits({id:e,css:t}){if(!e)throw new Error("search hits id is not defined");let o=document.querySelector(`#${e}`);o.innerHTML=`<div id="${e}-init" class="${t?.div||this.hitsCss}"></div>`}searchPagination({id:e,css:t}){if(!e)throw new Error("search pagination id is not defined");let o=document.querySelector(`#${e}`);o.innerHTML=`<div id="${e}-init"
                              class="${t?.div||this.paginationcss}"></div>`}searchInput({id:e,placeholder:t,button:o,css:s}){if(!this.container)throw new Error("main search div container is not defined");if(!e)throw new Error("search input id is not defined");let i=document.querySelector(`#${this.container}`);i.innerHTML=`<div id="${e}" class="${s?.div||this.div1css}">
        <select id="${`${e}-select`}"
          class="${s?.select||this.selectQueryCss}">
          <option value="simple">simple</option>
          <option value="cql">cql</option>
        </select>
        <input
          type="search"
          id="${`${e}-input`}"
          class="${s?.input||this.inputcss}"
          placeholder="${t||this.inputPlaceholder}"
          autocomplete="off"
        />
        <button id="noske-search-button" class="${s?.button||this.buttoncss}">${o||this.button}</button>
      </div>
    `}transformStats(e,t,o){let s=document.querySelector(`#${e.id}`),i=`<div id="${e.id}-init" class="${e.css.div}">
                    <label class="${e.css.label}">${o} ${t}</label>
                  </div>`;s.innerHTML=i}async transformResponse(e,t,o,s,i,n){let a=document.querySelector(`#${o.id}-init`);if(a.innerHTML="",e==="No results found")a.innerHTML=i?.results||this.results;else if(e.error)a.innerHTML=e.error;else{let c=L(e),l=G(e),h=Math.ceil(l/(t?.pagesize||this.pagesize)),w=document.querySelector(`#${s.id}-init`);w.innerHTML=`<select id="${`${s.id}-select`}"
          class="${s.css?.select||this.selectcss}">
          ${Array.from({length:h},(u,m)=>`<option value="${m+1}">${m+1}</option>`).join("")}
        </select>`,O(c,`${o.id}-init`,i?.customUrl||this.customUrl,i?.urlparam||this.urlparam,o),l&&this.transformStats({id:n.id,css:{div:n.css?.div||this.statsDiv,label:n.css?.label||this.statsLabel}},l,n.label||this.statsLabelValue)}}async createPagination(e=1,t,o,s,i,n,a){let c=document.querySelector(`#${s.id}-select`);c.addEventListener("change",async l=>{t.fromp=parseInt(l.target.value);let h=document.querySelector(`input#${i}-input`).value,w=await C(h,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:t.pagesize||this.pagesize,fromp:t.fromp||this.fromp,selectQueryId:`${i}-select`});await this.transformResponse(w,t,o,s,n,a),await this.createPagination(l.target.value,t,o,s,i,n,a)}),c.value=e.toString()}clearResults(e,t,o,s){document.querySelector(`input#${o}-input`).addEventListener("input",async n=>{if(n.target.value.length===0){let c=document.querySelector(`#${e}-init`);c.innerHTML="";let l=document.querySelector(`#${t}-init`);l.innerHTML="",document.querySelector(`#${s}-init`)?.remove(),window.history.pushState({},"",`${window.location.pathname}`),document.getElementById("nokse-autocomplete")?.remove()}})}};export{F as NoskeSearch};
//# sourceMappingURL=index.js.map